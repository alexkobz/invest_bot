{{
  config(
    materialized='incremental',
    incremental_strategy='merge',
    unique_key=["inn", "year", "ticker"],
    merge_update_columns=["type", 'code', 'active',
        'capex_revenue', 'capital', 'changed_at', 'current_ratio', 'debt_equity', 'debt_ratio',
        'debtebitda', 'dpr', 'ebitda_margin', 'ev_ebit', 'evebitda', 'evs', 'exchange', 'gross_margin',
        'interest_coverage', 'net_margin', 'net_working_capital', 'netdebt_ebitda', 'operation_margin',
        'pbv', 'pcf', 'pe', 'pfcf', 'pffo', 'ps', 'roa', 'roce', 'roe', 'roic', 'ros', '"1100"', '"1110"', '"1120"', '"1130"', '"1140"', '"1150"', '"1160"', '"1170"', '"1180"', '"1190"',
'"1200"', '"1210"', '"1220"', '"1230"', '"1240"', '"1250"', '"1260"', '"1300"', '"1310"', '"1320"', '"1340"', '"1350"',
'"1360"', '"1370"', '"1400"', '"1410"', '"1420"', '"1430"', '"1450"', '"1500"', '"1510"', '"1520"', '"1530"', '"1540"',
'"1550"', '"1600"', '"1700"', '"2100"', '"2110"', '"2120"', '"2200"', '"2210"', '"2220"', '"2300"', '"2310"', '"2320"',
'"2330"', '"2340"', '"2350"', '"2400"', '"2410"', '"2421"', '"2430"', '"2450"', '"2460"', '"2500"', '"2510"', '"2520"',
'"3200"', '"3300"', '"3310"', '"3311"', '"3312"', '"3313"', '"3314"', '"3315"', '"3316"', '"3320"', '"3321"', '"3322"',
'"3323"', '"3324"', '"3325"', '"3326"', '"3327"', '"3330"', '"3340"', '"3600"', '"4100"', '"4110"', '"4111"', '"4112"',
'"4113"', '"4119"', '"4120"', '"4121"', '"4122"', '"4123"', '"4124"', '"4129"', '"4200"', '"4210"', '"4211"', '"4212"',
'"4213"', '"4214"', '"4219"', '"4220"', '"4221"', '"4222"', '"4223"', '"4224"', '"4229"', '"4300"', '"4310"', '"4311"',
'"4312"', '"4313"', '"4314"', '"4319"', '"4320"', '"4321"', '"4322"', '"4323"', '"4329"', '"4400"', '"4490"', '"6100"',
'"6200"', '"6210"', '"6215"', '"6220"', '"6230"', '"6240"', '"6250"', '"6300"', '"6310"', '"6311"', '"6312"', '"6313"',
'"6320"', '"6321"', '"6322"', '"6323"', '"6324"', '"6325"', '"6326"', '"6330"', '"6350"', '"6400"', '"2411"', '"4450"',
'"4500"', '"2412"', '"3100"', '"3210"', '"3211"', '"3230"', '"3400"', '"3401"', '"3402"', '"3500"', '"3501"', '"3502"',
'"3220"', '"3221"', '"3410"', '"3411"', '"2900"', '"2910"', '"3213"', '"3227"', '"3223"', '"3420"', '"3421"', '"3240"',
'"3212"', '"3222"', '"2530"', '"3216"', '"3226"', '"3214"', '"3215"', '"3224"', '"3225"', '"3412"', '"3422"']
  )
}}
WITH fm_ratios AS (
    SELECT
        "year",
        "type",
        code,
        active,
        capex_revenue,
        capital,
        changed_at,
        current_ratio,
        debt_equity,
        debt_ratio,
        debtebitda,
        dpr,
        ebitda_margin,
        ev_ebit,
        evebitda,
        evs,
        exchange,
        gross_margin,
        interest_coverage,
        net_margin,
        net_working_capital,
        netdebt_ebitda,
        operation_margin,
        pbv,
        pcf,
        pe,
        pfcf,
        pffo,
        ps,
        roa,
        roce,
        roe,
        roic,
        ros
    FROM {{ ref('fm_ratios') }}
    WHERE period = 'Y' AND exchange = 'MOEX'
)
, girbo_fundamentals AS (
    SELECT
        inn,
        "year",
        "1100",
        "1110",
        "1120",
        "1130",
        "1140",
        "1150",
        "1160",
        "1170",
        "1180",
        "1190",
        "1200",
        "1210",
        "1220",
        "1230",
        "1240",
        "1250",
        "1260",
        "1300",
        "1310",
        "1320",
        "1340",
        "1350",
        "1360",
        "1370",
        "1400",
        "1410",
        "1420",
        "1430",
        "1450",
        "1500",
        "1510",
        "1520",
        "1530",
        "1540",
        "1550",
        "1600",
        "1700",
        "2100",
        "2110",
        "2120",
        "2200",
        "2210",
        "2220",
        "2300",
        "2310",
        "2320",
        "2330",
        "2340",
        "2350",
        "2400",
        "2410",
        "2421",
        "2430",
        "2450",
        "2460",
        "2500",
        "2510",
        "2520",
        "3200",
        "3300",
        "3310",
        "3311",
        "3312",
        "3313",
        "3314",
        "3315",
        "3316",
        "3320",
        "3321",
        "3322",
        "3323",
        "3324",
        "3325",
        "3326",
        "3327",
        "3330",
        "3340",
        "3600",
        "4100",
        "4110",
        "4111",
        "4112",
        "4113",
        "4119",
        "4120",
        "4121",
        "4122",
        "4123",
        "4124",
        "4129",
        "4200",
        "4210",
        "4211",
        "4212",
        "4213",
        "4214",
        "4219",
        "4220",
        "4221",
        "4222",
        "4223",
        "4224",
        "4229",
        "4300",
        "4310",
        "4311",
        "4312",
        "4313",
        "4314",
        "4319",
        "4320",
        "4321",
        "4322",
        "4323",
        "4329",
        "4400",
        "4490",
        "6100",
        "6200",
        "6210",
        "6215",
        "6220",
        "6230",
        "6240",
        "6250",
        "6300",
        "6310",
        "6311",
        "6312",
        "6313",
        "6320",
        "6321",
        "6322",
        "6323",
        "6324",
        "6325",
        "6326",
        "6330",
        "6350",
        "6400",
        "2411",
        "4450",
        "4500",
        "2412",
        "3100",
        "3210",
        "3211",
        "3230",
        "3400",
        "3401",
        "3402",
        "3500",
        "3501",
        "3502",
        "3220",
        "3221",
        "3410",
        "3411",
        "2900",
        "2910",
        "3213",
        "3227",
        "3223",
        "3420",
        "3421",
        "3240",
        "3212",
        "3222",
        "2530",
        "3216",
        "3226",
        "3214",
        "3215",
        "3224",
        "3225",
        "3412",
        "3422"
    FROM {{ ref('girbo_fundamentals') }}
)
, dim_shares AS (
    SELECT
        ticker,
        emitent_inn
    FROM {{ ref('dim_shares') }}
)
SELECT
    COALESCE(s.emitent_inn, g.inn) AS inn,
    COALESCE(fm."year", g."year") AS "year",
    COALESCE(fm.code, s.ticker) ticker,
    fm."type",
    fm.active,
    fm.capex_revenue,
    fm.capital,
    fm.changed_at,
    fm.current_ratio,
    fm.debt_equity,
    fm.debt_ratio,
    fm.debtebitda,
    fm.dpr,
    fm.ebitda_margin,
    fm.ev_ebit,
    fm.evebitda,
    fm.evs,
    fm.exchange,
    fm.gross_margin,
    fm.interest_coverage,
    fm.net_margin,
    fm.net_working_capital,
    fm.netdebt_ebitda,
    fm.operation_margin,
    fm.pbv,
    fm.pcf,
    fm.pe,
    fm.pfcf,
    fm.pffo,
    fm.ps,
    fm.roa,
    fm.roce,
    fm.roe,
    fm.roic,
    fm.ros,
    g."1100",
    g."1110",
    g."1120",
    g."1130",
    g."1140",
    g."1150",
    g."1160",
    g."1170",
    g."1180",
    g."1190",
    g."1200",
    g."1210",
    g."1220",
    g."1230",
    g."1240",
    g."1250",
    g."1260",
    g."1300",
    g."1310",
    g."1320",
    g."1340",
    g."1350",
    g."1360",
    g."1370",
    g."1400",
    g."1410",
    g."1420",
    g."1430",
    g."1450",
    g."1500",
    g."1510",
    g."1520",
    g."1530",
    g."1540",
    g."1550",
    g."1600",
    g."1700",
    g."2100",
    g."2110",
    g."2120",
    g."2200",
    g."2210",
    g."2220",
    g."2300",
    g."2310",
    g."2320",
    g."2330",
    g."2340",
    g."2350",
    g."2400",
    g."2410",
    g."2421",
    g."2430",
    g."2450",
    g."2460",
    g."2500",
    g."2510",
    g."2520",
    g."3200",
    g."3300",
    g."3310",
    g."3311",
    g."3312",
    g."3313",
    g."3314",
    g."3315",
    g."3316",
    g."3320",
    g."3321",
    g."3322",
    g."3323",
    g."3324",
    g."3325",
    g."3326",
    g."3327",
    g."3330",
    g."3340",
    g."3600",
    g."4100",
    g."4110",
    g."4111",
    g."4112",
    g."4113",
    g."4119",
    g."4120",
    g."4121",
    g."4122",
    g."4123",
    g."4124",
    g."4129",
    g."4200",
    g."4210",
    g."4211",
    g."4212",
    g."4213",
    g."4214",
    g."4219",
    g."4220",
    g."4221",
    g."4222",
    g."4223",
    g."4224",
    g."4229",
    g."4300",
    g."4310",
    g."4311",
    g."4312",
    g."4313",
    g."4314",
    g."4319",
    g."4320",
    g."4321",
    g."4322",
    g."4323",
    g."4329",
    g."4400",
    g."4490",
    g."6100",
    g."6200",
    g."6210",
    g."6215",
    g."6220",
    g."6230",
    g."6240",
    g."6250",
    g."6300",
    g."6310",
    g."6311",
    g."6312",
    g."6313",
    g."6320",
    g."6321",
    g."6322",
    g."6323",
    g."6324",
    g."6325",
    g."6326",
    g."6330",
    g."6350",
    g."6400",
    g."2411",
    g."4450",
    g."4500",
    g."2412",
    g."3100",
    g."3210",
    g."3211",
    g."3230",
    g."3400",
    g."3401",
    g."3402",
    g."3500",
    g."3501",
    g."3502",
    g."3220",
    g."3221",
    g."3410",
    g."3411",
    g."2900",
    g."2910",
    g."3213",
    g."3227",
    g."3223",
    g."3420",
    g."3421",
    g."3240",
    g."3212",
    g."3222",
    g."2530",
    g."3216",
    g."3226",
    g."3214",
    g."3215",
    g."3224",
    g."3225",
    g."3412",
    g."3422"
FROM dim_shares s
FULL JOIN fm_ratios fm ON fm.code = s.ticker
FULL JOIN girbo_fundamentals g ON s.emitent_inn = g.inn AND fm."year" = g."year"
WHERE coalesce(s.ticker, g.inn, '') != ''

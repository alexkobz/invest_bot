{{
  config(
    materialized='incremental',
    incremental_strategy='merge',
    unique_key=["year", "ticker", "inn"],
    merge_update_columns=['capex_revenue_rsbu', 'capex_revenue_msfo', 'capital_rsbu', 'capital_msfo',
     'current_ratio_rsbu', 'current_ratio_msfo', 'debt_equity_rsbu', 'debt_equity_msfo',
    'debt_ratio_rsbu', 'debt_ratio_msfo', 'debtebitda_rsbu', 'debtebitda_msfo', 'dpr_rsbu', 'dpr_msfo',
    'ebitda_margin_rsbu', 'ebitda_margin_msfo', 'ev_ebit_rsbu', 'ev_ebit_msfo', 'evebitda_rsbu', 'evebitda_msfo',
    'evs_rsbu', 'evs_msfo', 'gross_margin_rsbu', 'gross_margin_msfo', 'interest_coverage_rsbu', 'interest_coverage_msfo',
    'net_margin_rsbu', 'net_margin_msfo', 'net_working_capital_rsbu', 'net_working_capital_msfo',
    'netdebt_ebitda_rsbu', 'netdebt_ebitda_msfo', 'operation_margin_rsbu', 'operation_margin_msfo',
    'pbv_rsbu', 'pbv_msfo', 'pcf_rsbu', 'pcf_msfo', 'pe_rsbu', 'pe_msfo', 'pfcf_rsbu', 'pfcf_msfo',
    'pffo_rsbu', 'pffo_msfo', 'ps_rsbu', 'ps_msfo', 'roa_rsbu', 'roa_msfo', 'roce_rsbu', 'roce_msfo',
    'roe_rsbu', 'roe_msfo', 'roic_rsbu', 'roic_msfo', 'ros_rsbu', 'ros_msfo',
    '"1100"', '"1110"', '"1120"', '"1130"', '"1140"', '"1150"', '"1160"', '"1170"', '"1180"', '"1190"',
'"1200"', '"1210"', '"1220"', '"1230"', '"1240"', '"1250"', '"1260"', '"1300"', '"1310"', '"1320"', '"1340"', '"1350"',
'"1360"', '"1370"', '"1400"', '"1410"', '"1420"', '"1430"', '"1450"', '"1500"', '"1510"', '"1520"', '"1530"', '"1540"',
'"1550"', '"1600"', '"1700"', '"2100"', '"2110"', '"2120"', '"2200"', '"2210"', '"2220"', '"2300"', '"2310"', '"2320"',
'"2330"', '"2340"', '"2350"', '"2400"', '"2410"', '"2421"', '"2430"', '"2450"', '"2460"', '"2500"', '"2510"', '"2520"',
'"3200"', '"3300"', '"3310"', '"3311"', '"3312"', '"3313"', '"3314"', '"3315"', '"3316"', '"3320"', '"3321"', '"3322"',
'"3323"', '"3324"', '"3325"', '"3326"', '"3327"', '"3330"', '"3340"', '"3600"', '"4100"', '"4110"', '"4111"', '"4112"',
'"4113"', '"4119"', '"4120"', '"4121"', '"4122"', '"4123"', '"4124"', '"4129"', '"4200"', '"4210"', '"4211"', '"4212"',
'"4213"', '"4214"', '"4219"', '"4220"', '"4221"', '"4222"', '"4223"', '"4224"', '"4229"', '"4300"', '"4310"', '"4311"',
'"4312"', '"4313"', '"4314"', '"4319"', '"4320"', '"4321"', '"4322"', '"4323"', '"4329"', '"4400"', '"4490"', '"6100"',
'"6200"', '"6210"', '"6215"', '"6220"', '"6230"', '"6240"', '"6250"', '"6300"', '"6310"', '"6311"', '"6312"', '"6313"',
'"6320"', '"6321"', '"6322"', '"6323"', '"6324"', '"6325"', '"6326"', '"6330"', '"6350"', '"6400"', '"2411"', '"4450"',
'"4500"', '"2412"', '"3100"', '"3210"', '"3211"', '"3230"', '"3400"', '"3401"', '"3402"', '"3500"', '"3501"', '"3502"',
'"3220"', '"3221"', '"3410"', '"3411"', '"2900"', '"2910"', '"3213"', '"3227"', '"3223"', '"3420"', '"3421"', '"3240"',
'"3212"', '"3222"', '"2530"', '"3216"', '"3226"', '"3214"', '"3215"', '"3224"', '"3225"', '"3412"', '"3422"']
  )
}}
WITH fm_ratios AS (
    SELECT DISTINCT ON ("year", code)
        "year",
        code,
		changed_at,
        MAX(CASE WHEN type='РСБУ' THEN capex_revenue END) capex_revenue_rsbu,
        MAX(CASE WHEN type='МСФО' THEN capex_revenue END) capex_revenue_msfo,
        MAX(CASE WHEN type='РСБУ' THEN capital END) capital_rsbu,
        MAX(CASE WHEN type='МСФО' THEN capital END) capital_msfo,
        MAX(CASE WHEN type='РСБУ' THEN current_ratio END) current_ratio_rsbu,
        MAX(CASE WHEN type='МСФО' THEN current_ratio END) current_ratio_msfo,
        MAX(CASE WHEN type='РСБУ' THEN debt_equity END) debt_equity_rsbu,
        MAX(CASE WHEN type='МСФО' THEN debt_equity END) debt_equity_msfo,
        MAX(CASE WHEN type='РСБУ' THEN debt_ratio END) debt_ratio_rsbu,
        MAX(CASE WHEN type='МСФО' THEN debt_ratio END) debt_ratio_msfo,
        MAX(CASE WHEN type='РСБУ' THEN debtebitda END) debtebitda_rsbu,
        MAX(CASE WHEN type='МСФО' THEN debtebitda END) debtebitda_msfo,
        MAX(CASE WHEN type='РСБУ' THEN dpr END) dpr_rsbu,
        MAX(CASE WHEN type='МСФО' THEN dpr END) dpr_msfo,
        MAX(CASE WHEN type='РСБУ' THEN ebitda_margin END) ebitda_margin_rsbu,
        MAX(CASE WHEN type='МСФО' THEN ebitda_margin END) ebitda_margin_msfo,
        MAX(CASE WHEN type='РСБУ' THEN ev_ebit END) ev_ebit_rsbu,
        MAX(CASE WHEN type='МСФО' THEN ev_ebit END) ev_ebit_msfo,
        MAX(CASE WHEN type='РСБУ' THEN evebitda END) evebitda_rsbu,
        MAX(CASE WHEN type='МСФО' THEN evebitda END) evebitda_msfo,
        MAX(CASE WHEN type='РСБУ' THEN evs END) evs_rsbu,
        MAX(CASE WHEN type='МСФО' THEN evs END) evs_msfo,
        MAX(CASE WHEN type='РСБУ' THEN gross_margin END) gross_margin_rsbu,
        MAX(CASE WHEN type='МСФО' THEN gross_margin END) gross_margin_msfo,
        MAX(CASE WHEN type='РСБУ' THEN interest_coverage END) interest_coverage_rsbu,
        MAX(CASE WHEN type='МСФО' THEN interest_coverage END) interest_coverage_msfo,
        MAX(CASE WHEN type='РСБУ' THEN net_margin END) net_margin_rsbu,
        MAX(CASE WHEN type='МСФО' THEN net_margin END) net_margin_msfo,
        MAX(CASE WHEN type='РСБУ' THEN net_working_capital END) net_working_capital_rsbu,
        MAX(CASE WHEN type='МСФО' THEN net_working_capital END) net_working_capital_msfo,
        MAX(CASE WHEN type='РСБУ' THEN netdebt_ebitda END) netdebt_ebitda_rsbu,
        MAX(CASE WHEN type='МСФО' THEN netdebt_ebitda END) netdebt_ebitda_msfo,
        MAX(CASE WHEN type='РСБУ' THEN operation_margin END) operation_margin_rsbu,
        MAX(CASE WHEN type='МСФО' THEN operation_margin END) operation_margin_msfo,
        MAX(CASE WHEN type='РСБУ' THEN pbv END) pbv_rsbu,
        MAX(CASE WHEN type='МСФО' THEN pbv END) pbv_msfo,
        MAX(CASE WHEN type='РСБУ' THEN pcf END) pcf_rsbu,
        MAX(CASE WHEN type='МСФО' THEN pcf END) pcf_msfo,
        MAX(CASE WHEN type='РСБУ' THEN pe END) pe_rsbu,
        MAX(CASE WHEN type='МСФО' THEN pe END) pe_msfo,
        MAX(CASE WHEN type='РСБУ' THEN pfcf END) pfcf_rsbu,
        MAX(CASE WHEN type='МСФО' THEN pfcf END) pfcf_msfo,
        MAX(CASE WHEN type='РСБУ' THEN pffo END) pffo_rsbu,
        MAX(CASE WHEN type='МСФО' THEN pffo END) pffo_msfo,
        MAX(CASE WHEN type='РСБУ' THEN ps END) ps_rsbu,
        MAX(CASE WHEN type='МСФО' THEN ps END) ps_msfo,
        MAX(CASE WHEN type='РСБУ' THEN roa END) roa_rsbu,
        MAX(CASE WHEN type='МСФО' THEN roa END) roa_msfo,
        MAX(CASE WHEN type='РСБУ' THEN roce END) roce_rsbu,
        MAX(CASE WHEN type='МСФО' THEN roce END) roce_msfo,
        MAX(CASE WHEN type='РСБУ' THEN roe END) roe_rsbu,
        MAX(CASE WHEN type='МСФО' THEN roe END) roe_msfo,
        MAX(CASE WHEN type='РСБУ' THEN roic END) roic_rsbu,
        MAX(CASE WHEN type='МСФО' THEN roic END) roic_msfo,
        MAX(CASE WHEN type='РСБУ' THEN ros END) ros_rsbu,
        MAX(CASE WHEN type='МСФО' THEN ros END) ros_msfo
    FROM {{ ref('fm_ratios') }}
    WHERE period = 'Y' AND exchange = 'MOEX'
    GROUP BY
        "year",
        code,
        changed_at
    ORDER BY "year", code, changed_at::timestamp desc
)
, girbo_fundamentals AS (
    SELECT DISTINCT ON ("year", inn)
        inn,
        "year",
        "1100",
        "1110",
        "1120",
        "1130",
        "1140",
        "1150",
        "1160",
        "1170",
        "1180",
        "1190",
        "1200",
        "1210",
        "1220",
        "1230",
        "1240",
        "1250",
        "1260",
        "1300",
        "1310",
        "1320",
        "1340",
        "1350",
        "1360",
        "1370",
        "1400",
        "1410",
        "1420",
        "1430",
        "1450",
        "1500",
        "1510",
        "1520",
        "1530",
        "1540",
        "1550",
        "1600",
        "1700",
        "2100",
        "2110",
        "2120",
        "2200",
        "2210",
        "2220",
        "2300",
        "2310",
        "2320",
        "2330",
        "2340",
        "2350",
        "2400",
        "2410",
        "2421",
        "2430",
        "2450",
        "2460",
        "2500",
        "2510",
        "2520",
        "3200",
        "3300",
        "3310",
        "3311",
        "3312",
        "3313",
        "3314",
        "3315",
        "3316",
        "3320",
        "3321",
        "3322",
        "3323",
        "3324",
        "3325",
        "3326",
        "3327",
        "3330",
        "3340",
        "3600",
        "4100",
        "4110",
        "4111",
        "4112",
        "4113",
        "4119",
        "4120",
        "4121",
        "4122",
        "4123",
        "4124",
        "4129",
        "4200",
        "4210",
        "4211",
        "4212",
        "4213",
        "4214",
        "4219",
        "4220",
        "4221",
        "4222",
        "4223",
        "4224",
        "4229",
        "4300",
        "4310",
        "4311",
        "4312",
        "4313",
        "4314",
        "4319",
        "4320",
        "4321",
        "4322",
        "4323",
        "4329",
        "4400",
        "4490",
        "6100",
        "6200",
        "6210",
        "6215",
        "6220",
        "6230",
        "6240",
        "6250",
        "6300",
        "6310",
        "6311",
        "6312",
        "6313",
        "6320",
        "6321",
        "6322",
        "6323",
        "6324",
        "6325",
        "6326",
        "6330",
        "6350",
        "6400",
        "2411",
        "4450",
        "4500",
        "2412",
        "3100",
        "3210",
        "3211",
        "3230",
        "3400",
        "3401",
        "3402",
        "3500",
        "3501",
        "3502",
        "3220",
        "3221",
        "3410",
        "3411",
        "2900",
        "2910",
        "3213",
        "3227",
        "3223",
        "3420",
        "3421",
        "3240",
        "3212",
        "3222",
        "2530",
        "3216",
        "3226",
        "3214",
        "3215",
        "3224",
        "3225",
        "3412",
        "3422"
    FROM {{ ref('girbo_fundamentals') }}
    ORDER BY "year", inn
)
, dim_shares AS (
    SELECT
        ticker,
        emitent_inn
    FROM {{ ref('dim_shares') }}
)
SELECT
    nextval('events_id_seq') id,
    COALESCE(fm."year", g."year") AS "year",
    COALESCE(fm.code, s.ticker, '') ticker,
    COALESCE(s.emitent_inn, g.inn, '') AS inn,
    fm.capex_revenue_rsbu,
    fm.capex_revenue_msfo,
    fm.capital_rsbu,
    fm.capital_msfo,
    fm.current_ratio_rsbu,
    fm.current_ratio_msfo,
    fm.debt_equity_rsbu,
    fm.debt_equity_msfo,
    fm.debt_ratio_rsbu,
    fm.debt_ratio_msfo,
    fm.debtebitda_rsbu,
    fm.debtebitda_msfo,
    fm.dpr_rsbu,
    fm.dpr_msfo,
    fm.ebitda_margin_rsbu,
    fm.ebitda_margin_msfo,
    fm.ev_ebit_rsbu,
    fm.ev_ebit_msfo,
    fm.evebitda_rsbu,
    fm.evebitda_msfo,
    fm.evs_rsbu,
    fm.evs_msfo,
    fm.gross_margin_rsbu,
    fm.gross_margin_msfo,
    fm.interest_coverage_rsbu,
    fm.interest_coverage_msfo,
    fm.net_margin_rsbu,
    fm.net_margin_msfo,
    fm.net_working_capital_rsbu,
    fm.net_working_capital_msfo,
    fm.netdebt_ebitda_rsbu,
    fm.netdebt_ebitda_msfo,
    fm.operation_margin_rsbu,
    fm.operation_margin_msfo,
    fm.pbv_rsbu,
    fm.pbv_msfo,
    fm.pcf_rsbu,
    fm.pcf_msfo,
    fm.pe_rsbu,
    fm.pe_msfo,
    fm.pfcf_rsbu,
    fm.pfcf_msfo,
    fm.pffo_rsbu,
    fm.pffo_msfo,
    fm.ps_rsbu,
    fm.ps_msfo,
    fm.roa_rsbu,
    fm.roa_msfo,
    fm.roce_rsbu,
    fm.roce_msfo,
    fm.roe_rsbu,
    fm.roe_msfo,
    fm.roic_rsbu,
    fm.roic_msfo,
    fm.ros_rsbu,
    fm.ros_msfo,
    g."1100",
    g."1110",
    g."1120",
    g."1130",
    g."1140",
    g."1150",
    g."1160",
    g."1170",
    g."1180",
    g."1190",
    g."1200",
    g."1210",
    g."1220",
    g."1230",
    g."1240",
    g."1250",
    g."1260",
    g."1300",
    g."1310",
    g."1320",
    g."1340",
    g."1350",
    g."1360",
    g."1370",
    g."1400",
    g."1410",
    g."1420",
    g."1430",
    g."1450",
    g."1500",
    g."1510",
    g."1520",
    g."1530",
    g."1540",
    g."1550",
    g."1600",
    g."1700",
    g."2100",
    g."2110",
    g."2120",
    g."2200",
    g."2210",
    g."2220",
    g."2300",
    g."2310",
    g."2320",
    g."2330",
    g."2340",
    g."2350",
    g."2400",
    g."2410",
    g."2421",
    g."2430",
    g."2450",
    g."2460",
    g."2500",
    g."2510",
    g."2520",
    g."3200",
    g."3300",
    g."3310",
    g."3311",
    g."3312",
    g."3313",
    g."3314",
    g."3315",
    g."3316",
    g."3320",
    g."3321",
    g."3322",
    g."3323",
    g."3324",
    g."3325",
    g."3326",
    g."3327",
    g."3330",
    g."3340",
    g."3600",
    g."4100",
    g."4110",
    g."4111",
    g."4112",
    g."4113",
    g."4119",
    g."4120",
    g."4121",
    g."4122",
    g."4123",
    g."4124",
    g."4129",
    g."4200",
    g."4210",
    g."4211",
    g."4212",
    g."4213",
    g."4214",
    g."4219",
    g."4220",
    g."4221",
    g."4222",
    g."4223",
    g."4224",
    g."4229",
    g."4300",
    g."4310",
    g."4311",
    g."4312",
    g."4313",
    g."4314",
    g."4319",
    g."4320",
    g."4321",
    g."4322",
    g."4323",
    g."4329",
    g."4400",
    g."4490",
    g."6100",
    g."6200",
    g."6210",
    g."6215",
    g."6220",
    g."6230",
    g."6240",
    g."6250",
    g."6300",
    g."6310",
    g."6311",
    g."6312",
    g."6313",
    g."6320",
    g."6321",
    g."6322",
    g."6323",
    g."6324",
    g."6325",
    g."6326",
    g."6330",
    g."6350",
    g."6400",
    g."2411",
    g."4450",
    g."4500",
    g."2412",
    g."3100",
    g."3210",
    g."3211",
    g."3230",
    g."3400",
    g."3401",
    g."3402",
    g."3500",
    g."3501",
    g."3502",
    g."3220",
    g."3221",
    g."3410",
    g."3411",
    g."2900",
    g."2910",
    g."3213",
    g."3227",
    g."3223",
    g."3420",
    g."3421",
    g."3240",
    g."3212",
    g."3222",
    g."2530",
    g."3216",
    g."3226",
    g."3214",
    g."3215",
    g."3224",
    g."3225",
    g."3412",
    g."3422"
FROM dim_shares s
FULL JOIN fm_ratios fm ON fm.code = s.ticker
FULL JOIN girbo_fundamentals g ON s.emitent_inn = g.inn AND fm."year" = g."year"
WHERE coalesce(s.ticker, g.inn, '') != '' AND COALESCE(fm."year", g."year", 0) != 0

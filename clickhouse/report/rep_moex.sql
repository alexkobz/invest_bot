CREATE MATERIALIZED VIEW mv_moex
TO rep_moex AS
WITH generated_dates AS (
    SELECT
        secid,
        arrayJoin(arrayMap(x -> toDate(x), range(toUInt32(min_date), toUInt32(max_date) + 1, 1))) AS tradedate
    FROM (
        SELECT secid, MIN(tradedate) AS min_date, MAX(tradedate) AS max_date
        FROM moex_prices
        WHERE boardid IN ('EQBS', 'EQBR', 'TQBS', 'TQBR')
        GROUP BY secid
    )
)
, tmp_prices AS (
    SELECT *
    FROM (
        SELECT
            *,
            row_number() OVER(PARTITION BY secid, tradedate ORDER BY volume DESC) AS rn
        FROM moex_prices
        WHERE boardid IN ('EQBS', 'EQBR', 'TQBS', 'TQBR')
    )
    WHERE rn = 1
)
, moex_ratios AS (
	SELECT *
	FROM v_ratios
	WHERE exchange = 'MOEX'
)
SELECT
    d.secid AS secid,
    argMax(p.boardid, d.tradedate) OVER (PARTITION BY d.secid ORDER BY d.tradedate) AS boardid,
    d.tradedate AS tradedate,
    year(d.tradedate) AS "year",
    p.tradedate IS NOT NULL AS is_workday,
    argMax(p.numtrades, d.tradedate) OVER (PARTITION BY d.secid ORDER BY d.tradedate) AS numtrades,
    argMax(p.value, d.tradedate) OVER (PARTITION BY d.secid ORDER BY d.tradedate) AS value,
    argMax(p.open, d.tradedate) OVER (PARTITION BY d.secid ORDER BY d.tradedate) AS open,
    argMax(p.low, d.tradedate) OVER (PARTITION BY d.secid ORDER BY d.tradedate) AS low,
    argMax(p.high, d.tradedate) OVER (PARTITION BY d.secid ORDER BY d.tradedate) AS high,
    argMax(p.close, d.tradedate) OVER (PARTITION BY d.secid ORDER BY d.tradedate) AS close,
    argMax(p.volume, d.tradedate) OVER (PARTITION BY d.secid ORDER BY d.tradedate) AS volume,
    r.inn AS r_inn,
    r.active,
    r.capex_revenue,
    r.capital,
    r.changed_at,
    r.current_ratio,
    r.debt_equity,
    r.debt_ratio,
    r.debtebitda,
    r.dpr,
    r.ebitda_margin,
    r.ev_ebit,
    r.evebitda,
    r.evs,
    r.exchange,
    r.gross_margin,
    r.interest_coverage,
    r."month",
    r.net_margin,
    r.net_working_capital,
    r.netdebt_ebitda,
    r.operation_margin,
    r.pbv,
    r.pcf,
    r.pe,
    r.period,
    r.pfcf,
    r.pffo,
    r.ps,
    r.roa,
    r.roce,
    r.roe,
    r.roic,
    r.ros,
    r.type,
    r."1100",
    r."1110",
    r."1120",
    r."1130",
    r."1140",
    r."1150",
    r."1160",
    r."1170",
    r."1180",
    r."1190",
    r."1200",
    r."1210",
    r."1220",
    r."1230",
    r."1240",
    r."1250",
    r."1260",
    r."1300",
    r."1310",
    r."1320",
    r."1340",
    r."1350",
    r."1360",
    r."1370",
    r."1400",
    r."1410",
    r."1420",
    r."1430",
    r."1450",
    r."1500",
    r."1510",
    r."1520",
    r."1530",
    r."1540",
    r."1550",
    r."1600",
    r."1700",
    r."2100",
    r."2110",
    r."2120",
    r."2200",
    r."2210",
    r."2220",
    r."2300",
    r."2310",
    r."2320",
    r."2330",
    r."2340",
    r."2350",
    r."2400",
    r."2410",
    r."2421",
    r."2430",
    r."2450",
    r."2460",
    r."2500",
    r."2510",
    r."2520",
    r."3200",
    r."3300",
    r."3310",
    r."3311",
    r."3312",
    r."3313",
    r."3314",
    r."3315",
    r."3316",
    r."3320",
    r."3321",
    r."3322",
    r."3323",
    r."3324",
    r."3325",
    r."3326",
    r."3327",
    r."3330",
    r."3340",
    r."3600",
    r."4100",
    r."4110",
    r."4111",
    r."4112",
    r."4113",
    r."4119",
    r."4120",
    r."4121",
    r."4122",
    r."4123",
    r."4124",
    r."4129",
    r."4200",
    r."4210",
    r."4211",
    r."4212",
    r."4213",
    r."4214",
    r."4219",
    r."4220",
    r."4221",
    r."4222",
    r."4223",
    r."4224",
    r."4229",
    r."4300",
    r."4310",
    r."4311",
    r."4312",
    r."4313",
    r."4314",
    r."4319",
    r."4320",
    r."4321",
    r."4322",
    r."4323",
    r."4329",
    r."4400",
    r."4490",
    r."6100",
    r."6200",
    r."6210",
    r."6215",
    r."6220",
    r."6230",
    r."6240",
    r."6250",
    r."6300",
    r."6310",
    r."6311",
    r."6312",
    r."6313",
    r."6320",
    r."6321",
    r."6322",
    r."6323",
    r."6324",
    r."6325",
    r."6326",
    r."6330",
    r."6350",
    r."6400",
    r."2411",
    r."4450",
    r."4500",
    r."2412",
    r."3100",
    r."3210",
    r."3211",
    r."3230",
    r."3400",
    r."3401",
    r."3402",
    r."3500",
    r."3501",
    r."3502",
    r."3220",
    r."3221",
    r."3410",
    r."3411",
    r."2900",
    r."2910",
    r."3213",
    r."3227",
    r."3223",
    r."3420",
    r."3421",
    r."3240",
    r."3212",
    r."3222",
    r."2530",
    r."3216",
    r."3226",
    r."3214",
    r."3215",
    r."3224",
    r."3225",
    r."3412",
    r."3422"
FROM generated_dates AS d
LEFT JOIN tmp_prices AS p
    ON d.secid = p.secid
    AND d.tradedate = p.tradedate
LEFT JOIN moex_ratios r ON d.secid = r.code AND year(d.tradedate) = r."year"
WHERE r.type IS NOT NULL
SETTINGS join_use_nulls = 1
